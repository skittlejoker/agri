<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Your Email - AgriMarket</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body data-page="verify">
    <main class="auth-container">
        <section class="card">
            <div class="card-header">
                <i class="fa-solid fa-envelope-circle-check"></i>
                <h1>Verify Your Email</h1>
                <p class="subtitle">Enter the verification code sent to your email</p>
            </div>
            <form id="verifyForm" class="form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" placeholder="your@email.com" required>
                    <small class="error" id="emailError"></small>
                    <button type="button" id="sendCodeBtn" class="btn btn-secondary"
                        style="width: 100%; margin-top: 10px; display: none;">
                        <i class="fa-solid fa-paper-plane"></i> Send Verification Code
                    </button>
                </div>
                <div class="form-group" id="codeGroup" style="display: none;">
                    <label for="verification_code">Verification Code</label>
                    <input type="text" id="verification_code" name="verification_code" placeholder="Enter 6-digit code"
                        maxlength="6" pattern="[0-9]{6}">
                    <small class="error" id="verificationCodeError"></small>
                    <small class="help-text">Check your email for the 6-digit verification code</small>
                </div>
                <button type="submit" class="btn btn-primary btn-block" id="verifyBtn" style="display: none;">
                    <span>Verify Email</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <div class="form-footer">
                    <p>Didn't receive the code? <a href="#" id="resendCodeLink">Resend verification code</a></p>
                    <p>Already verified? <a href="login.html">Login here</a></p>
                </div>
            </form>
        </section>
    </main>

    <script>
        (function () {
            const form = document.getElementById('verifyForm');
            const emailInput = document.getElementById('email');
            const codeInput = document.getElementById('verification_code');
            const emailError = document.getElementById('emailError');
            const codeError = document.getElementById('verificationCodeError');

            function showError(el, msg) {
                if (!el) return;
                el.textContent = msg || '';
            }

            // Pre-fill email from URL parameter (if coming from registration)
            function prefillEmail() {
                const urlParams = new URLSearchParams(window.location.search);
                const emailFromUrl = urlParams.get('email');
                if (emailFromUrl) {
                    try {
                        const decodedEmail = decodeURIComponent(emailFromUrl);
                        emailInput.value = decodedEmail;
                        emailInput.readOnly = true; // Make it read-only since it came from registration
                        emailInput.style.backgroundColor = '#f5f5f5';
                        emailInput.style.cursor = 'not-allowed';
                        console.log('Email pre-filled from URL:', decodedEmail);
                        return true;
                    } catch (e) {
                        console.error('Error decoding email from URL:', e);
                    }
                } else {
                    console.log('No email parameter in URL');
                }
                return false;
            }

            // Pre-fill email on page load
            const emailPrefilled = prefillEmail();

            // Get UI elements
            const sendCodeBtn = document.getElementById('sendCodeBtn');
            const codeGroup = document.getElementById('codeGroup');
            const verifyBtn = document.getElementById('verifyBtn');

            // Show/hide elements based on email pre-fill
            if (emailPrefilled) {
                // Email is pre-filled from registration, show code input immediately
                codeGroup.style.display = 'block';
                verifyBtn.style.display = 'block';
                codeInput.focus();
            } else {
                // Email not pre-filled, show send code button
                sendCodeBtn.style.display = 'block';
            }

            // Handle email input change
            emailInput.addEventListener('input', function () {
                if (this.value.trim() && !emailPrefilled) {
                    sendCodeBtn.style.display = 'block';
                }
            });

            // Handle "Send Verification Code" button (uses test_registration_direct.php method)
            if (sendCodeBtn) {
                sendCodeBtn.addEventListener('click', async function (e) {
                    e.preventDefault();
                    showError(emailError, '');

                    const email = emailInput.value.trim();

                    if (!email) {
                        showError(emailError, 'Email is required');
                        return;
                    }

                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        showError(emailError, 'Enter a valid email');
                        return;
                    }

                    sendCodeBtn.disabled = true;
                    sendCodeBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';

                    try {
                        const response = await fetch('api/send_verification_email.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                email: email
                            })
                        });

                        const responseText = await response.text();
                        let result;
                        try {
                            result = JSON.parse(responseText);
                        } catch (parseError) {
                            console.error('Error parsing response:', parseError);
                            showError(emailError, 'Invalid response from server. Please try again.');
                            sendCodeBtn.disabled = false;
                            sendCodeBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Verification Code';
                            return;
                        }

                        if (result.success) {
                            showError(emailError, '');

                            // Show verification code if provided (for testing if email fails)
                            let message = 'Verification code has been sent to ' + email + '. Please check your inbox and spam folder.';
                            if (result.verification_code) {
                                message += '\n\nFor testing, your code is: ' + result.verification_code;
                            }

                            alert(message);

                            // If code is provided, auto-fill it
                            if (result.verification_code) {
                                codeInput.value = result.verification_code;
                            }

                            // Show code input and verify button
                            codeGroup.style.display = 'block';
                            verifyBtn.style.display = 'block';
                            sendCodeBtn.style.display = 'none';
                            codeInput.focus();
                        } else {
                            let errorMsg = result.error || 'Failed to send verification code';

                            // Show verification code if provided (for testing)
                            if (result.verification_code) {
                                errorMsg += '\n\nFor testing, your code is: ' + result.verification_code;
                                codeInput.value = result.verification_code;
                                codeGroup.style.display = 'block';
                                verifyBtn.style.display = 'block';
                            }

                            showError(emailError, errorMsg);
                            sendCodeBtn.disabled = false;
                            sendCodeBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Verification Code';
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showError(emailError, 'Network error. Please try again.');
                        sendCodeBtn.disabled = false;
                        sendCodeBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Verification Code';
                    }
                });
            }

            // Only allow numbers in verification code input
            codeInput.addEventListener('input', function (e) {
                this.value = this.value.replace(/[^0-9]/g, '');
            });

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                showError(emailError, '');
                showError(codeError, '');

                const email = emailInput.value.trim();
                const verificationCode = codeInput.value.trim();

                let valid = true;
                if (!email) {
                    showError(emailError, 'Email is required');
                    valid = false;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    showError(emailError, 'Enter a valid email');
                    valid = false;
                }
                if (!verificationCode) {
                    showError(codeError, 'Verification code is required');
                    valid = false;
                } else if (verificationCode.length !== 6) {
                    showError(codeError, 'Verification code must be 6 digits');
                    valid = false;
                }
                if (!valid) return;

                const submitBtn = verifyBtn || form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...';

                try {
                    const response = await fetch('api/verify.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            verification_code: verificationCode
                        })
                    });

                    const responseText = await response.text();
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('Error parsing response:', parseError);
                        showError(codeError, 'Invalid response from server. Please try again.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }

                    if (result.success) {
                        // Show success message
                        alert('Email verified successfully! Redirecting to login...');
                        window.location.href = 'login.html';
                    } else {
                        showError(codeError, result.error || 'Verification failed');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError(codeError, 'Network error. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            });

            // Handle resend verification code (uses same reliable method as test_registration_direct.php)
            const resendCodeLink = document.getElementById('resendCodeLink');
            if (resendCodeLink) {
                resendCodeLink.addEventListener('click', async function (e) {
                    e.preventDefault();

                    const email = emailInput.value.trim();
                    if (!email) {
                        showError(emailError, 'Please enter your email address first');
                        return;
                    }

                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        showError(emailError, 'Enter a valid email address');
                        return;
                    }

                    resendCodeLink.style.pointerEvents = 'none';
                    resendCodeLink.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';

                    try {
                        // Use the same reliable API endpoint as test_registration_direct.php
                        const response = await fetch('api/send_verification_email.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                email: email
                            })
                        });

                        const responseText = await response.text();
                        let result;
                        try {
                            result = JSON.parse(responseText);
                        } catch (parseError) {
                            console.error('Error parsing response:', parseError);
                            showError(emailError, 'Invalid response from server. Please try again.');
                            resendCodeLink.style.pointerEvents = 'auto';
                            resendCodeLink.innerHTML = 'Resend verification code';
                            return;
                        }

                        if (result.success) {
                            showError(emailError, '');
                            showError(codeError, '');
                            alert('Verification code has been resent to your email. Please check your inbox and spam folder.');
                            codeInput.value = ''; // Clear the code input
                            codeInput.focus(); // Focus on code input
                            // Ensure code input is visible
                            codeGroup.style.display = 'block';
                            verifyBtn.style.display = 'block';
                        } else {
                            showError(emailError, result.error || 'Failed to resend verification code');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showError(emailError, 'Network error. Please try again.');
                    } finally {
                        resendCodeLink.style.pointerEvents = 'auto';
                        resendCodeLink.innerHTML = 'Resend verification code';
                    }
                });
            }
        })();
    </script>
</body>

</html>